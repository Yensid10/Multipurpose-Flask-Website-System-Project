<!DOCTYPE html>
<html lang="en">
<head>
    <title>Kitchen Staff</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="{{ url_for('static', filename='css/kitchenstyle.css') }}" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>$(document).on('click', '.accept-button', function () {
        // Get the order ID and data
        const orderID = $(this).data('order-id');
        const orderData = $(this).closest('tr').find('td').map(function () {
            return $(this).text();
        }).get();

        $('#order-queue-table-content').load(location.href + ' #order-queue-table');
        $('#accepted-orders-table-content').load(location.href + ' #accepted-orders-table');

        // Send the order data to the server to be accepted
        $.ajax({
            url: '/accept_order',
            type: 'POST',
            data: {
                'order_data': JSON.stringify({
                    'old_id': orderID,
                    'order_index': orderData[0],
                    'items': orderData[1],
                    'note': orderData[2]
                }),
                'time': Date.now()
            },
            success: function (data) {
                // If the order was accepted, remove it from the order queue table
                $(this).closest('tr').remove();
            }
        });
    });
    </script>
    <script>
        function addPingToQueue(orderIndex) {
            // Split the orderIndex to get the table number
            const tableNumber = orderIndex.split('-')[0];

            $.ajax({
                type: "POST",
                url: "/addPingToQueue",
                data: JSON.stringify({"pingType": "Food", "tableNo": "#" + tableNumber}),
                contentType: "application/json",
            });
        }
    </script>

    <script>
        function sendCancel(orderIndex) {
            // Split the orderIndex to get the table number
            const orderIndexParts = orderIndex.split('-');
            const tableNumber = orderIndexParts[0];
            const indexNumber = orderIndexParts[1];

            $.ajax({
                type: "POST",
                url: "/sendCancel",
                data: JSON.stringify({"pingType": "Food", "tableNo": "#" + tableNumber, "indexNo": indexNumber}),
                contentType: "application/json",
            });
        }
    </script>


    <script>
        $(document).on('click', '.complete-button', function () {
            // Get the order ID
            const orderID = $(this).data('order-id');

            $('#order-queue-table-content').load(location.href + ' #order-queue-table');
            $('#accepted-orders-table-content').load(location.href + ' #accepted-orders-table');

            // Send the order ID to the server to be completed
            $.ajax({
                url: '/complete_order',
                type: 'POST',
                data: {'order_id': orderID},
                success: function (data) {
                    // If the order was completed, remove it from the accepted orders table
                    $(this).closest('tr').remove();
                }
            });
        });
    </script>

    <script>
        // Refresh the tables every 5 seconds
        setInterval(function () {
            $('#order-queue-table-content').load(location.href + ' #order-queue-table');
            $('#accepted-orders-table-content').load(location.href + ' #accepted-orders-table');
        }, 5000);
    </script>


    <script>
        $(document).on('click', '.cancel-button', function () {
            // Get the order ID and order index from the table row
            const orderID = $(this).data('order-id');
            const orderIndex = $(this).closest('tr').find('td:first-child').text();

            $('#order-queue-table-content').load(location.href + ' #order-queue-table');
            $('#accepted-orders-table-content').load(location.href + ' #accepted-orders-table');

            // Send a POST request to cancel the item
            $.ajax({
                url: '/cancel_order',
                type: 'POST',
                data: {'order_id': orderID, 'order_index': orderIndex},
                success: function (data) {
                    // If the item was cancelled, remove it from the bill table
                    $(this).closest('tr').remove();
                }
            });
        });
    </script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link href="{{ url_for('static', filename='images/kitchenicon.png') }}" rel="icon" type="image/png">
    <script src="{{ url_for('static', filename='js/kitchen.js') }}"></script>

</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6">
            <div class="common-table-container">
                <h1 class="text-center mb-5">Order Queue</h1>
                <div id="order-queue-table-content">
                    <table class="table kitchen-table" id="order-queue-table">
                        <thead>
                        <tr>
                            <th>Index</th>
                            <th>Items</th>
                            <th>Note</th>
                            <th>Accept</th>
                            <th>Cancel</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for order in orders %}
                            <tr>
                                <td>{{ order["order_index"] }}</td>
                                <td>{{ order["items"] }}</td>
                                <td>{{ order["note"] }}</td>
                                <td>
                                    <button class="btn btn-primary accept-button" data-order-id="{{ order["_id"] }}">
                                        Accept
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-danger cancel-button" data-order-id="{{ order["_id"] }}"
                                            onclick="sendCancel('{{ order["order_index"] }}')">Cancel
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="common-table-container">
                <h1 class="text-center mb-5">Accepted Orders</h1>
                <div id="accepted-orders-table-content">
                    <table class="table accepted-table" id="accepted-orders-table">
                        <thead>
                        <tr>
                            <th>Index</th>
                            <th>Items</th>
                            <th>Note</th>
                            <th>Complete</th>
                            <th>Cancel</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for order in accepted_orders %}
                            <tr>
                                <td>{{ order["order_index"] }}</td>
                                <td>{{ order["items"] }}</td>
                                <td>{{ order["note"] }}</td>
                                <td>
                                    <button class="btn btn-primary complete-button" data-order-id="{{ order._id }}"
                                            onclick="addPingToQueue('{{ order["order_index"] }}')">Complete
                                    </button>
                                <td>
                                    <button class="btn btn-danger cancel-button" data-order-id="{{ order._id }}"
                                            onclick="sendCancel('{{ order["order_index"] }}')">Cancel
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>